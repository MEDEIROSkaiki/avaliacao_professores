{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  /* ============ PÁGINA DE PERFIL DO PROFESSOR ============ */
  .profile-grid-container {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 30px;
    align-items: flex-start;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto; 
  }

  /* --- Card do Professor (Esquerda) --- */
  .professor-card {
    background-color: #fff;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }
  .professor-image-placeholder {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background-color: var(--painel-central);
    margin: 0 auto 20px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5rem;
    color: var(--azul-acinzentado);
  }
  .professor-card h2 {
    text-align: center;
    font-size: 1.6rem;
    color: var(--azul-marinho);
    margin-bottom: 5px;
    font-weight: 600;
  }
  /* CSS para a lista de disciplinas na sidebar */
  .professor-card .subject-list {
    text-align: center;
    font-size: 1rem;
    color: var(--verde-escuro-letras);
    margin-bottom: 20px;
    list-style: none; /* Remove bolinhas */
    padding: 0;
  }
  .professor-card .subject-list li {
    font-weight: 500;
    padding: 4px 0;
    border-bottom: 1px solid var(--painel-central);
  }
  .professor-card .subject-list li:last-child {
    border-bottom: none;
  }

  /* --- Conteúdo Principal (Direita) --- */
  .evaluation-main { display: flex; flex-direction: column; gap: 30px; }
  
  /* --- Card Unificado --- */
  .unified-card {
    padding: 30px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }

  .disciplina-select-group {
    margin-bottom: 20px;
    text-align: left;
  }
  .disciplina-select-group label {
    font-weight: 600;
    color: var(--azul-marinho);
    margin-bottom: 8px;
    display: block;
    font-size: 1.2rem;
  }
  .disciplina-select-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--cinza-claro);
    border-radius: 8px;
    background-color: var(--painel-central);
    font-size: 1rem;
    font-family: 'Segoe UI', sans-serif;
  }
  
  .chart-container { 
    height: 350px; 
    position: relative;
    margin-top: 25px;
    margin-bottom: 30px;
  }
  
  /* --- Formulário de Notas (Dentro do Card Unificado) --- */
  #rating-form { text-align: center; }
  #rating-form h3 {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--azul-marinho);
    margin-bottom: 25px;
    border-top: 2px solid var(--painel-central);
    padding-top: 30px;
  }
  .rating-inputs {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 25px;
  }
  .rating-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--cinza-claro);
    flex: 1; 
    min-width: 120px; 
  }
  .rating-group.rg-didatica { background-color: #d1eef4; }
  .rating-group.rg-dificuldade { background-color: #d4edda; }
  .rating-group.rg-relacionamento { background-color: #fff3cd; }
  .rating-group.rg-pontualidade { background-color: #e2d9f3; }
  .rating-group label { font-weight: 600; margin-bottom: 8px; color: #333; }
  .rating-group input {
    width: 80px;
    padding: 10px;
    border: 1px solid var(--cinza-claro);
    border-radius: 6px;
    text-align: center;
    font-size: 1rem;
    font-weight: 500;
    box-sizing: border-box;
  }
  .btn-submit {
    padding: 12px 25px;
    font-size: 1rem;
    background-color: var(--verde-escuro-letras);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .btn-submit:hover { background-color: var(--azul-marinho); }

  /* --- Card de Comentários (Abaixo do Grid) --- */
  .comment-card {
    grid-column: 1 / -1; 
    margin-top: 30px;
    padding: 30px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }
  .comment-card h3 {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--azul-marinho);
    margin-bottom: 15px;
  }
  #comment-form textarea {
    width: 100%;
    height: 90px;
    padding: 15px;
    border: 1px solid var(--cinza-claro);
    border-radius: 8px;
    font-family: 'Segoe UI', sans-serif;
    font-size: 1rem;
    box-sizing: border-box;
    resize: vertical;
    background-color: var(--painel-central);
  }
  .comment-submit-area { text-align: right; margin-top: 10px; }
  .comment-submit-area button {
    background-color: var(--azul-acinzentado);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .comment-submit-area button:hover { background-color: var(--verde-escuro-letras); }
  .comments-list h3 {
    margin-top: 30px;
    border-bottom: 2px solid var(--painel-central);
    padding-bottom: 10px;
  }
  .comment {
    border-bottom: 1px solid var(--painel-central);
    padding: 15px 0;
  }
  .comment:last-child { border-bottom: none; padding-bottom: 0; }
  .comment .timestamp {
    font-size: 0.85rem;
    color: var(--cinza-escuro-letras);
    font-weight: 600;
    margin-bottom: 5px;
  }
  .comment p { margin: 0; line-height: 1.6; color: var(--verde-escuro-letras); }

  /* --- Responsividade --- */
  @media (max-width: 900px) {
    .profile-grid-container { grid-template-columns: 1fr; }
    .professor-card { position: static; max-width: 450px; margin: 0 auto; }
  }
  @media (max-width: 500px) {
    .rating-inputs { flex-direction: column; gap: 10px; }
    .rating-group input { width: 100%; }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4.3.0/build/index.umd.min.js"></script>

<div class="admin-container" style="max-width: 1200px; padding-top: 40px;">
  
  <div class="profile-grid-container">

    <aside class="professor-card">
        <div class="professor-image-placeholder">
            {% if professor.foto %}
                <img src="{{ professor.foto.url }}" alt="Foto de {{ professor.user.get_full_name }}" style="
                    width: 100%; 
                    height: 100%; 
                    object-fit: cover;
                    border-radius: 50%;
                ">
            {% else %}
                <i class="fa-solid fa-user"></i>
            {% endif %}
        </div>
        <h2>{{ professor.user.get_full_name }}</h2>
        <ul class="subject-list">
            {% for dp in professor.user.disciplinas_pessoa.all %}
                <li>{{ dp.disciplina.nome }}</li>
            {% empty %}
                <li>Nenhuma disciplina</li>
            {% endfor %}
        </ul>
    </aside>

    <section class="evaluation-main">
      
      <div class="unified-card">
        
        <div class="disciplina-select-group">
          <label for="main-disciplina-select">Selecione uma disciplina:</label>
          <select id="main-disciplina-select">
            <option value="all" selected>Ver todas as disciplinas</option>
            {% for dp in disciplinas_professor %}
              <option value="{{ dp.pk }}">{{ dp.disciplina.nome }}</option>
            {% endfor %}
          </select>
        </div>

        {% if request.user.user_type == 'admin' %}
            <div class="chart-container">
                <canvas id="boxplot"></canvas>
            </div>
        {% endif %}

        {% if request.user.user_type == 'aluno' %}
            <form id="rating-form">
            {% csrf_token %}
            <h3>Avaliar a disciplina selecionada</h3>
            <div class="rating-inputs">
                <div class="rating-group rg-didatica">
                <label for="nota-didatica">Didática</label>
                <input type="number" id="nota-didatica" name="didatica" min="0" max="10" step="0.5" placeholder="Nota" required>
                </div>
                <div class="rating-group rg-dificuldade">
                <label for="nota-dificuldade">Dificuldade</label>
                <input type="number" id="nota-dificuldade" name="dificuldade" min="0" max="10" step="0.5" placeholder="Nota" required>
                </div>
                <div class="rating-group rg-relacionamento">
                <label for="nota-relacionamento">Relacionamento</label>
                <input type="number" id="nota-relacionamento" name="relacionamento" min="0" max="10" step="0.5" placeholder="Nota" required>
                </div>
                <div class="rating-group rg-pontualidade">
                <label for="nota-pontualidade">Pontualidade</label>
                <input type="number" id="nota-pontualidade" name="pontualidade" min="0" max="10" step="0.5" placeholder="Nota" required>
                </div>
            </div>
            <button type="submit" class="btn-submit">Submeter Avaliação</button>
            </form>
        {% endif %}
      </div>
    </section>
  
    <section class="comment-card">
      
      {% if request.user.user_type == 'aluno' %}
        <form id="comment-form">
            {% csrf_token %}
            <h3>Adicione um comentário para a disciplina selecionada</h3>
            <textarea id="comment-text" placeholder="Seja construtivo e respeitoso. Seu comentário é anônimo." required></textarea>
            <div class="comment-submit-area">
            <button type="submit">Publicar</button>
            </div>
        </form>
      {% endif %}

      {% if request.user.user_type == 'admin' or request.user.user_type == 'professor' and request.user.id == professor.user.id %}
        
        <div class="comments-list">
            <h3>Comentários Recebidos</h3>
            
            {% for avaliacao in comentarios %}
            <div class="comment comment-item" data-disciplina-id="{{ avaliacao.disciplina_pessoa.pk }}">
                <div class="timestamp">{{ avaliacao.data_avaliacao|date:"d/m/Y - H:i:s" }}</div>
                <p>{{ avaliacao.comentario }}</p>
            </div>
            {% empty %}
            <div class="comment" id="no-comments-message">
                <p>Nenhum comentário disponível.</p>
            </div>
            {% endfor %}

            <div class="comment" id="no-filter-results-message" style="display: none;">
            <p>Nenhum comentário para esta disciplina específica.</p>
            </div>
        </div>

      {% elif request.user.user_type == 'aluno' or request.user.user_type == 'professor' %}
        <div style="margin-top: 20px; text-align: center; color: var(--verde-escuro-letras);">
            <p><i class="fa-solid fa-lock"></i> Os comentários e médias são informações confidenciais.</p>
         </div>
      {% endif %}
    </section>
  </div>
</div>

<script>
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  // Só carrega os dados se o usuário for ADMIN para evitar exposição no código fonte
  {% if request.user.user_type == 'admin' %}
    const graficoData = JSON.parse('{{ dados_grafico_json|safe }}');
  {% else %}
    const graficoData = null;
  {% endif %}

  document.addEventListener('DOMContentLoaded', function() {

    let myChart = null; 
    const mainSelect = document.getElementById('main-disciplina-select');
    
    // Pega elementos opcionais (podem não existir dependendo do usuário)
    const ratingForm = document.getElementById('rating-form');
    const commentForm = document.getElementById('comment-form');

    // --- 1. GRÁFICO (SÓ EXECUTA SE O ELEMENTO EXISTIR) ---
    const canvasElement = document.getElementById('boxplot');
    
    if (canvasElement && graficoData) {
        const ctx = canvasElement.getContext('2d');
        const initialData = graficoData['all'];

        if (initialData) {
            const config = {
                type: 'boxplot',
                data: {
                    labels: ['Didática', 'Dificuldade', 'Relacionamento', 'Pontualidade'],
                    datasets: [{
                    label: 'Avaliações',
                    data: [
                        initialData.didatica,
                        initialData.dificuldade,
                        initialData.relacionamento,
                        initialData.pontualidade
                    ],
                    backgroundColor: ['#d1eef4', '#d4edda', '#fff3cd', '#e2d9f3'],
                    borderColor: ['#0b2958', '#155724', '#856404', '#381c5c'],
                    borderWidth: 1.5,
                    padding: 10,
                    itemRadius: 3,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 10 } }
                }
            };
            myChart = new Chart(ctx, config);
        }
    }

    // --- 2. ATUALIZAR GRÁFICO ---
    function updateChart(disciplinaId) {
      if (!myChart || !graficoData) return; // Se não tem gráfico, não faz nada

      const dataForChart = graficoData[disciplinaId];
      if (!dataForChart) {
        myChart.data.datasets[0].data = [[], [], [], []];
        myChart.update();
        return;
      }
      myChart.data.datasets[0].data = [
        dataForChart.didatica,
        dataForChart.dificuldade,
        dataForChart.relacionamento,
        dataForChart.pontualidade
      ];
      myChart.update();
    }

    // --- 3. MOSTRAR/ESCONDER FORMULÁRIOS (SÓ SE EXISTIREM) ---
    function toggleFormsVisibility(show) {
      if(ratingForm) ratingForm.style.display = show ? 'block' : 'none';
      if(commentForm) commentForm.style.display = show ? 'block' : 'none';
    }

    // --- 4. FILTRAR COMENTÁRIOS ---
    function updateCommentVisibility(disciplinaId) {
      const allComments = document.querySelectorAll('.comment-item');
      if (allComments.length === 0) return; // Se não tem comentários, sai

      const noCommentsMsg = document.getElementById('no-comments-message');
      const noFilterMsg = document.getElementById('no-filter-results-message');
      
      let commentsFound = 0;

      allComments.forEach(comment => {
        const commentDisciplinaId = comment.dataset.disciplinaId;
        if (disciplinaId === 'all' || commentDisciplinaId === disciplinaId) {
          comment.style.display = 'block';
          commentsFound++;
        } else {
          comment.style.display = 'none';
        }
      });

      if (noCommentsMsg) noCommentsMsg.style.display = 'none';
      if (noFilterMsg) noFilterMsg.style.display = 'none';

      if (commentsFound === 0) {
        if (allComments.length === 0 && noCommentsMsg) {
          noCommentsMsg.style.display = 'block';
        } else if (noFilterMsg) {
          noFilterMsg.style.display = 'block';
        }
      }
    }

    // --- 5. EVENTO SELECT ---
    mainSelect.addEventListener('change', function() {
      const selectedId = this.value;
      updateChart(selectedId); 
      
      if (selectedId === 'all') {
        toggleFormsVisibility(false);
      } else {
        toggleFormsVisibility(true);
      }
      
      updateCommentVisibility(selectedId);
    });

    // --- 6. SUBMIT AVALIAÇÃO (SÓ ALUNO) ---
    if (ratingForm) {
      ratingForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const selectedDisciplinaId = mainSelect.value;
        if (selectedDisciplinaId === 'all') {
          alert('Por favor, selecione uma disciplina específica para avaliar.');
          return;
        }

        const formData = new FormData(ratingForm);
        const notas = {
          disciplina_pessoa_id: selectedDisciplinaId,
          didatica: formData.get('didatica'),
          dificuldade: formData.get('dificuldade'),
          relacionamento: formData.get('relacionamento'),
          pontualidade: formData.get('pontualidade')
        };

        fetch("{% url 'salvar_avaliacao_api' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify(notas)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Avaliação salva com sucesso!');
            location.reload(); 
          } else {
            alert('Erro: ' + data.error);
          }
        });
      });
    }

    // --- 7. SUBMIT COMENTÁRIO (SÓ ALUNO) ---
    if (commentForm) {
      commentForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const selectedDisciplinaId = mainSelect.value;
        if (selectedDisciplinaId === 'all') {
          alert('Por favor, selecione uma disciplina específica para comentar.');
          return;
        }
        
        const comentario = {
          disciplina_pessoa_id: selectedDisciplinaId,
          texto: document.getElementById('comment-text').value
        };

        fetch("{% url 'salvar_comentario_api' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify(comentario)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Comentário salvo!');
            location.reload(); 
          } else {
            alert('Erro: ' + data.error);
          }
        });
      });
    }

    // Inicialização
    toggleFormsVisibility(false); 
    updateCommentVisibility('all');
  });
</script>

{% endblock content %}