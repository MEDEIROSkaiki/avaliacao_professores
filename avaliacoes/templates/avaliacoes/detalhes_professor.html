{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  /* ============ PÁGINA DE PERFIL DO PROFESSOR ============ */
  .profile-grid-container {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 30px;
    align-items: flex-start;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto; 
  }

  /* --- Card do Professor (Esquerda) --- */
  .professor-card {
    background-color: #fff;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }
  .professor-image-placeholder {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background-color: var(--painel-central);
    margin: 0 auto 20px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5rem;
    color: var(--azul-acinzentado);
  }
  .professor-card h2 {
    text-align: center;
    font-size: 1.6rem;
    color: var(--azul-marinho);
    margin-bottom: 5px;
    font-weight: 600;
  }
  .professor-card .subject {
    text-align: center;
    font-weight: 500;
    color: var(--verde-escuro-letras);
    margin-bottom: 20px;
    font-size: 1rem;
  }

  /* --- Conteúdo Principal (Direita) --- */
  .evaluation-main { display: flex; flex-direction: column; gap: 30px; }
  
  /* --- NOVO: Card Unificado --- */
  .unified-card {
    padding: 30px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }

  .disciplina-select-group {
    margin-bottom: 20px;
    text-align: left;
  }
  .disciplina-select-group label {
    font-weight: 600;
    color: var(--azul-marinho);
    margin-bottom: 8px;
    display: block;
    font-size: 1.2rem;
  }
  .disciplina-select-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--cinza-claro);
    border-radius: 8px;
    background-color: var(--painel-central);
    font-size: 1rem;
    font-family: 'Segoe UI', sans-serif;
  }
  
  .chart-container { 
    height: 350px; 
    position: relative;
    margin-top: 25px;
    margin-bottom: 30px;
  }
  
  /* --- Formulário de Notas (Dentro do Card Unificado) --- */
  #rating-form { text-align: center; }
  #rating-form h3 {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--azul-marinho);
    margin-bottom: 25px;
    border-top: 2px solid var(--painel-central);
    padding-top: 30px;
  }
  .rating-inputs {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 25px;
  }
  .rating-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--cinza-claro);
    flex: 1; 
    min-width: 120px; 
  }
  .rating-group.rg-didatica { background-color: #d1eef4; }
  .rating-group.rg-dificuldade { background-color: #d4edda; }
  .rating-group.rg-relacionamento { background-color: #fff3cd; }
  .rating-group.rg-pontualidade { background-color: #e2d9f3; }
  .rating-group label { font-weight: 600; margin-bottom: 8px; color: #333; }
  .rating-group input {
    width: 80px;
    padding: 10px;
    border: 1px solid var(--cinza-claro);
    border-radius: 6px;
    text-align: center;
    font-size: 1rem;
    font-weight: 500;
    box-sizing: border-box;
  }
  .btn-submit {
    padding: 12px 25px;
    font-size: 1rem;
    background-color: var(--verde-escuro-letras);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .btn-submit:hover { background-color: var(--azul-marinho); }

  /* --- Card de Comentários (Abaixo do Grid) --- */
  .comment-card {
    grid-column: 1 / -1; 
    margin-top: 30px; /* <--- ESPAÇAMENTO ADICIONADO */
    padding: 30px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }
  .comment-card h3 {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--azul-marinho);
    margin-bottom: 15px;
  }
  #comment-form textarea {
    width: 100%;
    height: 90px;
    padding: 15px;
    border: 1px solid var(--cinza-claro);
    border-radius: 8px;
    font-family: 'Segoe UI', sans-serif;
    font-size: 1rem;
    box-sizing: border-box;
    resize: vertical;
    background-color: var(--painel-central);
  }
  .comment-submit-area { text-align: right; margin-top: 10px; }
  .comment-submit-area button {
    background-color: var(--azul-acinzentado);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .comment-submit-area button:hover { background-color: var(--verde-escuro-letras); }
  .comments-list h3 {
    margin-top: 30px;
    border-bottom: 2px solid var(--painel-central);
    padding-bottom: 10px;
  }
  .comment {
    border-bottom: 1px solid var(--painel-central);
    padding: 15px 0;
  }
  .comment:last-child { border-bottom: none; padding-bottom: 0; }
  .comment .timestamp {
    font-size: 0.85rem;
    color: var(--cinza-escuro-letras);
    font-weight: 600;
    margin-bottom: 5px;
  }
  .comment p { margin: 0; line-height: 1.6; color: var(--verde-escuro-letras); }

  /* --- Responsividade --- */
  @media (max-width: 900px) {
    .profile-grid-container { grid-template-columns: 1fr; }
    .professor-card { position: static; max-width: 450px; margin: 0 auto; }
  }
  @media (max-width: 500px) {
    .rating-inputs { flex-direction: column; gap: 10px; }
    .rating-group input { width: 100%; }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4.3.0/build/index.umd.min.js"></script>

<div class="admin-container" style="max-width: 1200px; padding-top: 40px;">
  
  <div class="profile-grid-container">

    <aside class="professor-card">
        <div class="professor-image-placeholder">
            {% if professor.foto %}
                <img src="{{ professor.foto.url }}" alt="Foto de {{ professor.user.get_full_name }}" style="
                    width: 100%; 
                    height: 100%; 
                    object-fit: cover;
                    border-radius: 50%;
                ">
            {% else %}
                <i class="fa-solid fa-user"></i>
            {% endif %}
        </div>
        <h2>{{ professor.user.get_full_name }}</h2>
        <div class="subject">
            {% for dp in professor.user.disciplinas_pessoa.all %}
                {{ dp.disciplina.nome }}
                {% if not forloop.last %}, {% endif %}
            {% empty %}
                Nenhuma disciplina
            {% endfor %}
        </div>
        </aside>

    <section class="evaluation-main">
      
      <div class="unified-card">
        
        <div class="disciplina-select-group">
          <label for="main-disciplina-select">Selecione uma disciplina para ver detalhes e avaliar:</label>
          <select id="main-disciplina-select">
            <option value="all" selected>Ver todas as disciplinas (Média Geral)</option>
            {% for dp in disciplinas_professor %}
              <option value="{{ dp.pk }}">{{ dp.disciplina.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="chart-container">
          <canvas id="boxplot"></canvas>
        </div>

        <form id="rating-form">
          {% csrf_token %}
          <h3>Avaliar a disciplina selecionada</h3>
          <div class="rating-inputs">
            <div class="rating-group rg-didatica">
              <label for="nota-didatica">Didática</label>
              <input type="number" id="nota-didatica" name="didatica" min="0" max="10" step="0.5" placeholder="Nota" required>
            </div>
            <div class="rating-group rg-dificuldade">
              <label for="nota-dificuldade">Dificuldade</label>
              <input type="number" id="nota-dificuldade" name="dificuldade" min="0" max="10" step="0.5" placeholder="Nota" required>
            </div>
            <div class="rating-group rg-relacionamento">
              <label for="nota-relacionamento">Relacionamento</label>
              <input type="number" id="nota-relacionamento" name="relacionamento" min="0" max="10" step="0.5" placeholder="Nota" required>
            </div>
            <div class="rating-group rg-pontualidade">
              <label for="nota-pontualidade">Pontualidade</label>
              <input type="number" id="nota-pontualidade" name="pontualidade" min="0" max="10" step="0.5" placeholder="Nota" required>
            </div>
          </div>
          <button type="submit" class="btn-submit">Submeter Avaliação</button>
        </form>
      </div>
    </section>
  
    <section class="comment-card">
      
      <form id="comment-form">
        {% csrf_token %}
        <h3>Adicione um comentário para a disciplina selecionada</h3>
        <textarea id="comment-text" placeholder="Seja construtivo e respeitoso. Seu comentário é anônimo." required></textarea>
        <div class="comment-submit-area">
          <button type="submit">Publicar</button>
        </div>
      </form>

      <div class="comments-list">
        <h3>Comentários</h3>
        {% for avaliacao in comentarios %}
          <div class="comment">
            <div class="timestamp">{{ avaliacao.data_avaliacao|date:"d/m/Y - H:i:s" }}</div>
            <p>{{ avaliacao.comentario }}</p>
          </div>
        {% empty %}
          <div class="comment" id="no-comments-message">
            <p>Nenhum comentário para este professor ainda.</p>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>
</div>

<script>
  // Pega o token CSRF globalmente para todos os fetches
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Pega os dados do gráfico do contexto do Django
  const graficoData = JSON.parse('{{ dados_grafico_json|safe }}');

  document.addEventListener('DOMContentLoaded', function() {

    let myChart; // Variável global para o gráfico
    const ctx = document.getElementById('boxplot').getContext('2d');
    const mainSelect = document.getElementById('main-disciplina-select');
    
    // --- NOVO: Pega os formulários para esconder/mostrar ---
    const ratingForm = document.getElementById('rating-form');
    const commentForm = document.getElementById('comment-form');

    // --- 1. FUNÇÃO PARA ATUALIZAR O GRÁFICO ---
    function updateChart(disciplinaId) {
      const dataForChart = graficoData[disciplinaId];
      if (!dataForChart) {
        // Isso pode acontecer se a view estiver errada
        console.error('Nenhum dado encontrado para a disciplina:', disciplinaId);
        myChart.data.datasets[0].data = [[], [], [], []];
        myChart.update();
        return;
      }

      myChart.data.datasets[0].data = [
        dataForChart.didatica,
        dataForChart.dificuldade,
        dataForChart.relacionamento,
        dataForChart.pontualidade
      ];
      myChart.update();
    }

    // --- NOVO: FUNÇÃO PARA MOSTRAR/ESCONDER OS FORMULÁRIOS ---
    function toggleFormsVisibility(show) {
      // Usamos 'block' e 'none' para mostrar/esconder os formulários
      ratingForm.style.display = show ? 'block' : 'none';
      commentForm.style.display = show ? 'block' : 'none';
    }

    // --- 2. INICIALIZAÇÃO DO GRÁFICO ---
    // Verifica se 'all' existe antes de tentar acessá-lo
    const initialData = graficoData['all'];
    if (!initialData) {
        console.error("Erro fatal: 'graficoData['all']' não encontrado. Verifique sua views.py.");
        // Não podemos continuar se os dados iniciais falharem.
        return; 
    }

    const config = {
      type: 'boxplot',
      data: {
        labels: ['Didática', 'Dificuldade', 'Relacionamento', 'Pontualidade'],
        datasets: [{
          label: 'Avaliações',
          data: [
            initialData.didatica,
            initialData.dificuldade,
            initialData.relacionamento,
            initialData.pontualidade
          ],
          backgroundColor: ['#d1eef4', '#d4edda', '#fff3cd', '#e2d9f3'],
          borderColor: ['#0b2958', '#155724', '#856404', '#381c5c'],
          borderWidth: 1.5,
          padding: 10,
          itemRadius: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, title: { display: false } },
        scales: { y: { beginAtZero: true, max: 10, ticks: { stepSize: 1 } } }
      }
    };
    myChart = new Chart(ctx, config);

    // --- 3. EVENT LISTENER DO DROPDOWN MESTRE ---
    mainSelect.addEventListener('change', function() {
      const selectedId = this.value;
      updateChart(selectedId);
      
      // NOVO: Mostra os forms se uma disciplina for selecionada, esconde se for 'all'
      if (selectedId === 'all') {
        toggleFormsVisibility(false);
      } else {
        toggleFormsVisibility(true);
      }
    });

    // --- 4. LÓGICA DO FORMULÁRIO DE AVALIAÇÃO ---
    if (ratingForm) {
      ratingForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const selectedDisciplinaId = mainSelect.value;
        // Validação já existe, mas mantemos por segurança
        if (selectedDisciplinaId === 'all') {
          alert('Por favor, selecione uma disciplina específica para avaliar.');
          return;
        }

        const formData = new FormData(ratingForm);
        const notas = {
          disciplina_pessoa_id: selectedDisciplinaId,
          didatica: formData.get('didatica'),
          dificuldade: formData.get('dificuldade'),
          relacionamento: formData.get('relacionamento'),
          pontualidade: formData.get('pontualidade')
        };

        if (!notas.didatica || !notas.dificuldade || !notas.relacionamento || !notas.pontualidade) {
            alert('Por favor, preencha todas as 4 notas.');
            return;
        }

        fetch("{% url 'salvar_avaliacao_api' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify(notas)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Avaliação salva com sucesso! O gráfico será atualizado.');
            location.reload(); 
          } else {
            alert('Erro ao salvar avaliação: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Erro no fetch:', error);
          alert('Ocorreu um erro de rede. Tente novamente.');
        });
      });
    }

    // --- 5. LÓGICA DO FORMULÁRIO DE COMENTÁRIO ---
    if (commentForm) {
      commentForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const selectedDisciplinaId = mainSelect.value;
        if (selectedDisciplinaId === 'all') {
          alert('Por favor, selecione uma disciplina específica para comentar.');
          return;
        }
        
        const comentario = {
          disciplina_pessoa_id: selectedDisciplinaId,
          texto: document.getElementById('comment-text').value
        };

        if (comentario.texto.trim() === '') {
           alert('O comentário não pode estar vazio.');
           return;
        }

        fetch("{% url 'salvar_comentario_api' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify(comentario)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            addCommentToDOM(comentario.texto, data.timestamp);
            commentForm.reset();
          } else {
            // CORREÇÃO: Removido o '_' que estava aqui
            alert('Erro ao salvar comentário: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Erro no fetch:', error);
          alert('Ocorreu um erro de rede. Tente novamente.');
        });
      });
    }

    // Função para adicionar o novo comentário à lista
    function addCommentToDOM(text, timestamp) {
      const noCommentsMsg = document.getElementById('no-comments-message');
      if (noCommentsMsg) { noCommentsMsg.style.display = 'none'; }

      const ts = new Date(timestamp).toLocaleString('pt-BR');
      const newComment = document.createElement('div');
      newComment.className = 'comment';
      const timeDiv = document.createElement('div');
      timeDiv.className = 'timestamp';
      timeDiv.textContent = ts;
      const p = document.createElement('p');
      p.textContent = text;
      newComment.appendChild(timeDiv);
      newComment.appendChild(p);
      
      const commentList = document.querySelector('.comments-list');
      commentList.insertBefore(newComment, commentList.children[1]);
    }

    // --- NOVO: Esconde os forms na inicialização ---
    toggleFormsVisibility(false);

  });
</script>

{% endblock content %}